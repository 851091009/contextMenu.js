/*
 *contextMenu.js v 1.0.0 Beta
 *Author: Sudhanshu Yadav
 *s-yadav.github.com
 *Copyright (c) 2013 Sudhanshu Yadav.
 *Dual licensed under the MIT and GPL licenses
*/
(function(e,t,n,r){e.fn.contextMenu=function(t,n,r){"use strict";if(!i[t]){r=n;n=t;t="popup"}else if(n!=null){if(!(n instanceof Array||typeof n==="string"||n.nodeType||n.jquery)){r=n;n=null}}if(n instanceof Array&&t!="update"){t="menu"}var o=r;if(t!="update"){r=s.optionOtimizer(t,r);var o=e.extend({},e.fn.contextMenu.defaults,r);if(!o.baseTrigger){o.baseTrigger=this}}i[t].call(this,n,o);return this};e.fn.contextMenu.defaults={triggerOn:"click",displayAround:"cursor",mouseClick:"left",verAdjust:0,horAdjust:0,containment:t,sizeStyle:"auto",position:"auto",onOpen:function(e,t){},onClose:function(e,t){}};var i={menu:function(t,n){var r=e(this);t=s.createMenuList(r,t,n);s.contextMenuBind.call(this,t,n,"menu")},popup:function(t,n){e(t).addClass("iw-contextMenu");s.contextMenuBind.call(this,t,n,"popup")},update:function(t,n){this.each(function(){var r=e(this),i=r.data("iw-menuData"),o=i.menu;if(typeof t==="object"){for(var u=0;u<t.length;u++){var a=t[u].name,f=t[u].disable,l=o.find("li").filter(function(){return e(this).text()==a}),c=t[u].subMenu;if(f=="true"){l.addClass("m-disable")}else{l.removeClass("m-disable")}if(c){l.contextMenu("update",c)}}s.onOff(o)}i.option=e.extend({},i.option,n);r.data("iw-menuData",i)})},refresh:function(){var t=this.filter(function(){return e(this).data("iw-menuData")!=null}).data("iw-menuData"),n=this.filter(function(){return e(this).data("iw-menuData")==null});s.contextMenuBind.call(n,t.menuSelector,t.option)},destroy:function(){this.each(function(){var t=e(this),n=t.data("iw-menuData").menuId,r=e(".iw-contextMenu[menuId="+n+"]");t.unbind(".contextMenu");e("#contextMenuTempTextBox").remove();for(var i=0;i<r.length;i++){var s=e(r[i]),o=s.data("iw-menuData");if(o.noTrigger==1){if(s.hasClass("iw-created")){s.remove();break}else{s.removeClass("iw-contextMenu "+s.attr["menuId"]).removeAttr("menuId").removeData("iw-menuData")}}else{o.noTrigger--;s.data("iw-menuData",o)}}t.removeData("iw-menuData")})}};var s={contextMenuBind:function(t,n,r){var i=this,o=e(t),u=o.data("iw-menuData");if(o.length==0){o=i.find(t);if(o.length==0){return}}if(r=="menu"){s.menuHover(o)}var a=n.baseTrigger;if(a.index(i)!=-1){o.addClass("iw-curMenu")}if(!u){var f;if(!a.data("iw-menuData")){f=Math.ceil(Math.random()*1e5);a.data("iw-menuData",{menuId:f})}else{f=a.data("iw-menuData").menuId}var l=o.clone();l.appendTo("body");u={menuId:f,menuWidth:l.outerWidth(true),menuHeight:l.outerHeight(true),noTrigger:1,trigger:i};o.data("iw-menuData",u).attr("menuId",f);l.remove()}else{u.noTrigger++;o.data("iw-menuData",u)}i.data("iw-menuData",{menuId:u.menuId,option:n,menu:o,menuSelector:t,method:r});if(n.triggerOn=="hover"){var c="mouseenter";if(a.index(i)!=-1){a.add(o).bind("mouseleave.contextMenu",function(t){if(e(t.relatedTarget).closest(".iw-contextMenu").length==0){e('.iw-contextMenu[menuId="'+u.menuId+'"]').hide(100)}})}}else{var c=n.triggerOn}s.tempTextBox();i.bind(c+".contextMenu",s.eventHandler);o.bind("click mouseenter mouseleave",function(e){e.stopPropagation()})},eventHandler:function(r){r.preventDefault();var i=e(this),o=i.data("iw-menuData"),u=o.menu,a=u.data("iw-menuData"),f=o.option,l=f.containment;f.onOpen.call(this,{trigger:i,menu:u},r);var c=e(l);cHeight=c.height(),cWidth=c.width(),menuHeight=a.menuHeight,menuWidth=a.menuWidth,verAdjust=parseInt(f.verAdjust),horAdjust=parseInt(f.horAdjust),posLeft=false;if(l!=t&&c.css("position")=="static"){c.css("position","relative")}if(f.sizeStyle=="auto"){menuHeight=Math.min(menuHeight,cHeight);menuWidth=Math.min(menuWidth,cWidth)}if(f.displayAround=="cursor"){var h=l==t?r.pageX-c.scrollLeft():r.pageX-c.offset().left,p=l==t?r.pageY-c.scrollTop():r.pageY-c.offset().top;var d=p+menuHeight,v=h+menuWidth;if(d>cHeight){if(p-menuHeight<0){if(d-cHeight<menuHeight-p){p=cHeight-menuHeight;verAdjust=-1*verAdjust}else{p=0;verAdjust=0}}else{p=p-menuHeight;verAdjust=-1*verAdjust}}if(v>cWidth){if(h-menuWidth<0){if(v-cWidth<menuWidth-h){h=cWidth-menuWidth;horAdjust=-1*horAdjust;posLeft=true}else{h=0;horAdjust=0}}else{h=h-menuWidth;horAdjust=-1*horAdjust;posLeft=true}}}else if(f.displayAround=="trigger"){var m=i.outerHeight(true),g=i.outerWidth(true),y=l==t?i.offset().left-c.scrollLeft():i.position().left,b=l==t?i.offset().top-c.scrollTop():i.position().top,h=y+g,p=b,w=g;var d=p+menuHeight,v=h+menuWidth;if(d>cHeight){if(p-menuHeight<0){if(d-cHeight<menuHeight-p){p=cHeight-menuHeight;verAdjust=-1*verAdjust}else{p=0;verAdjust=0}}else{p=p-menuHeight+m;verAdjust=-1*verAdjust}}if(v>cWidth){if(h-menuWidth<0){if(v-cWidth<menuWidth-h){h=cWidth-menuWidth;horAdjust=-1*horAdjust;posLeft=true;w=-g}else{h=0;horAdjust=0;w=0}}else{h=h-menuWidth-g;horAdjust=-1*horAdjust;posLeft=true;w=-g}}if(f.position=="top"){menuHeight=Math.min(a.menuHeight,b);p=b-menuHeight;verAdjust=parseInt(f.verAdjust);h=h-w}else if(f.position=="left"){menuWidth=Math.min(a.menuWidth,y);h=y-menuWidth;horAdjust=parseInt(f.horAdjust)}else if(f.position=="bottom"){menuHeight=Math.min(a.menuHeight,cHeight-b-m);p=b+m;verAdjust=parseInt(f.verAdjust);h=h-w}else if(f.position=="right"){menuWidth=Math.min(a.menuWidth,cWidth-y-g);h=y+g;horAdjust=parseInt(f.horAdjust)}}var E=u.outerWidth(true)-u.width(),S=u.outerHeight(true)-u.height();var x={position:l==t?"fixed":"absolute",display:"inline-block",top:p+verAdjust+"px",height:"",width:"","overflow-y":menuHeight!=a.menuHeight?"auto":"hidden","overflow-x":menuWidth!=a.menuWidth?"auto":"hidden"};if(f.sizeStyle=="auto"){x.height=menuHeight-S+"px";x.width=menuWidth-E+20+"px";h=h+20*(posLeft?-1:0)}x.left=h+horAdjust+"px";u.css(x);if(!i.is("input,select,textarea")&&o.method=="menu"){e("#iw-tempTxt").focus()}if(i.closest(".iw-contextMenu").length==0){e(".iw-curMenu").removeClass("iw-curMenu");u.addClass("iw-curMenu")}e(n.documentElement).unbind("keyup",s.keyEvent);e("body").unbind("click",s.clickEvent);var T={trigger:i,menu:u,option:f,method:o.method};e("body").click(T,s.clickEvent);e(n.documentElement).keyup(T,s.keyEvent);if(l==t){e(t).bind("scroll resize",T,s.scrollEvent)}},scrollEvent:function(e){s.closeContextMenu(e.data.option,e.data.trigger,e.data.menu,e)},clickEvent:function(t){var n=t.data.trigger.get(0);if(n!==t.target&&e(t.target).closest(".iw-contextMenu").length==0){s.closeContextMenu(t.data.option,t.data.trigger,t.data.menu,t)}},closeContextMenu:function(r,i,o,u){e(n.documentElement).unbind("keyup",s.keyEvent);e("body").unbind("click",s.clickEvent);e(t).unbind("scroll resize",s.scrollEvent);e(".iw-contextMenu").hide();e(n).focus();r.onClose.call(this,{trigger:i,menu:o},u)},keyEvent:function(t){var n=t.data.menu,r=t.data.option,i=t.keyCode;if(i==27){s.closeContextMenu(r,t.data.trigger,n,t)}if(t.data.method=="menu"){var o=e(".iw-curMenu"),u=o.children("li:not(.m-disable)"),a=u.filter(".iw-selectedMenu"),f=u.index(a),l=function(e){a.removeClass("iw-selectedMenu");e.addClass("iw-selectedMenu")},c=function(){l(u.filter(":first"))},h=function(){l(u.filter(":last"))},p=function(){l(u.filter(":eq("+(f+1)+")"))},d=function(){l(u.filter(":eq("+(f-1)+")"))},v=function(){var e=a.data("iw-menuData");if(e){a.triggerHandler("mouseenter.contextMenu");var t=e.menu;t.addClass("iw-curMenu");o.removeClass("iw-curMenu");o=t;u=o.children("li:not(.m-disable)");a=u.filter(".iw-selectedMenu");c()}},m=function(){var e=o.data("iw-menuData").trigger;var t=e.closest(".iw-contextMenu");if(t.length!=0){o.removeClass("iw-curMenu").css("display","none");t.addClass("iw-curMenu")}};switch(i){case 13:a.click();break;case 40:a.length==0?c():p();break;case 38:a.length==0?h():d();break;case 33:c();break;case 34:h();break;case 37:m();break;case 39:v();break}}},menuHover:function(t){t.children("li").bind("mouseenter",function(n){e(".iw-curMenu").removeClass("iw-curMenu");t.addClass("iw-curMenu");var r=t.find("li.iw-selectedMenu"),i=r.find(".iw-contextMenu");if(i.length!=0&&r[0]!=this){i.hide(100)}r.removeClass("iw-selectedMenu");e(this).addClass("iw-selectedMenu")})},createMenuList:function(n,r,i){var o=i.baseTrigger,u=Math.floor(Math.random()*1e4);if(typeof r=="object"&&!r.nodeType&&!r.jquery){var a=e('<ul class="iw-contextMenu iw-created" id="iw-contextMenu'+u+'"></ul>');for(var f=0;f<r.length;f++){var l=r[f].name,c=r[f].fun,h=r[f].subMenu,p=r[f].img||"",d=r[f].title||l,v=r[f].disable,m=e('<li title="'+d+'">'+l+"</li>");if(p!=null&&p!=""){m.prepend('<img src="'+p+'" align="absmiddle" style="width:20px; height:20px; margin-right:10px" />')}if(v=="true"){m.addClass("m-disable")}m.bind("click",c);a.append(m);if(h){m.append('<div class="iw-arrow-right" />');s.subMenu(m,h,o)}}if(o.index(n[0])==-1){n.append(a)}else{var g=i.containment==t?"body":i.containment;e(g).append(a)}s.onOff(e("#iw-contextMenu"+u));return"#iw-contextMenu"+u}else if(e(r).length!=0){var y=e(r);y.removeClass("iw-contextMenuCurrent").addClass("iw-contextMenu iw-contextMenu"+u).attr("menuId","iw-contextMenu"+u).css("display","none");y.find("ul").each(function(t,n){var r=e(this),i=r.parent("li");i.append('<div class="iw-arrow-right" />');r.addClass("iw-contextMenuCurrent");s.subMenu(i,".iw-contextMenuCurrent",o)});s.onOff(e(".iw-contextMenu"+u));return".iw-contextMenu"+u}},subMenu:function(e,t,n){e.contextMenu("menu",t,{triggerOn:"hover",displayAround:"trigger",position:"auto",baseTrigger:n})},onOff:function(t){t.find(".iw-overlay").remove();t.find(".m-disable").each(function(){var t=e(this);t.append('<div class="iw-overlay"/>');t.find(".iw-overlay").bind("click mouseenter",function(e){e.stopPropagation()})})},tempTextBox:function(){var t=e("#iw-tempTxt");if(t.length==0){e("body").append('<input type="text" id="iw-tempTxt" />');e("#iw-tempTxt").css({position:"fixed",bottom:"1px",left:"1px",width:"0px",border:"none"})}},optionOtimizer:function(e,t){if(!t){return}if(e=="menu"){if(!t.mouseClick){t.mouseClick="right"}}if(t.mouseClick=="right"&&t.triggerOn=="click"){t.triggerOn="contextmenu"}if(t.triggerOn!="click"&&t.triggerOn!="mousemove"){if(!t.displayAround){t.displayAround="trigger"}}if(["hover","mouseenter","mouseover","mouseleave","mouseout"].indexOf(t.triggerOn)!=-1){t.displayAround="trigger"}return t}}})(jQuery,window,document)