/*
 *contextMenu.js v 1.0.0 Beta
 *Author: Sudhanshu Yadav
 *s-yadav.github.com
 *Copyright (c) 2013 Sudhanshu Yadav.
 *Dual licensed under the MIT and GPL licenses
*/
(function(e,t,n,r){e.fn.contextMenu=function(t,n,r){"use strict";if(!i[t]){r=n;n=t;t="popup"}else if(n!=null){if(!(n instanceof Array||typeof n==="string"||n.nodeType||n.jquery)){r=n;n=null}}if(n instanceof Array&&t!="update"){t="menu"}var o=r;if(t!="update"){r=s.optionOtimizer(t,r);var o=e.extend({},e.fn.contextMenu.defaults,r);if(!o.baseTrigger){o.baseTrigger=this}}i[t].call(this,n,o);return this};e.fn.contextMenu.defaults={triggerOn:"click",displayAround:"cursor",mouseClick:"left",verAdjust:0,horAdjust:0,sizeStyle:"auto",position:"auto",onOpen:function(e,t){},onClose:function(e,t){}};var i={menu:function(t,n){var r=e(this);t=s.createMenuList(r,t,n);s.contextMenuBind.call(this,t,n,"menu")},popup:function(t,n){e(t).addClass("iw-contextMenu");s.contextMenuBind.call(this,t,n,"popup")},update:function(t,n){this.each(function(){var r=e(this),i=r.data("iw-menuData"),o=i.menu;if(typeof t==="object"){for(var u=0;u<t.length;u++){var a=t[u].name,f=t[u].disable,l=o.find("li").filter(function(){return e(this).text()==a}),c=t[u].subMenu;if(f=="true"){l.addClass("m-disable")}else{l.removeClass("m-disable")}if(c){l.contextMenu("update",c)}}s.onOff(o)}i.option=e.extend({},i.option,n);r.data("iw-menuData",i)})},refresh:function(){var t=this.filter(function(){return e(this).data("iw-menuData")!=null}).data("iw-menuData"),n=this.filter(function(){return e(this).data("iw-menuData")==null});s.contextMenuBind.call(n,t.menuSelector,t.option)},destroy:function(){this.each(function(){var t=e(this),n=t.data("iw-menuData").menuId,r=e(".iw-contextMenu[menuId="+n+"]");t.unbind(".contextMenu");e("#contextMenuTempTextBox").remove();for(var i=0;i<r.length;i++){var s=e(r[i]),o=s.data("iw-menuData");if(o.noTrigger==1){if(s.hasClass("iw-created")){s.remove();break}else{s.removeClass("iw-contextMenu "+s.attr["menuId"]).removeAttr("menuId").removeData("iw-menuData")}}else{o.noTrigger--;s.data("iw-menuData",o)}}t.removeData("iw-menuData")})}};var s={contextMenuBind:function(t,n,r){var i=this,o=e(t),u=o.data("iw-menuData");if(o.length==0){o=i.find(t);if(o.length==0){return}}if(r=="menu"){s.menuHover(o)}var a=n.baseTrigger;if(a.index(i)!=-1){o.addClass("iw-curMenu")}if(!u){var f;if(!a.data("iw-menuData")){f=Math.ceil(Math.random()*1e5);a.data("iw-menuData",{menuId:f})}else{f=a.data("iw-menuData").menuId}var l=o.clone();l.appendTo("body");u={menuId:f,menuWidth:l.outerWidth(true),menuHeight:l.outerHeight(true),noTrigger:1,trigger:i};o.data("iw-menuData",u).attr("menuId",f);l.remove()}else{u.noTrigger++;o.data("iw-menuData",u)}i.data("iw-menuData",{menuId:u.menuId,option:n,menu:o,menuSelector:t,method:r});if(n.triggerOn=="hover"){var c="mouseenter";if(a.index(i)!=-1){a.add(o).bind("mouseleave.contextMenu",function(t){if(e(t.relatedTarget).closest(".iw-contextMenu").length==0){e('.iw-contextMenu[menuId="'+u.menuId+'"]').hide(100)}})}}else{var c=n.triggerOn}s.tempTextBox();i.bind(c+".contextMenu",s.eventHandler);o.bind("click mouseenter mouseleave",function(){return false})},eventHandler:function(r){r.preventDefault();var i=e(this),o=i.data("iw-menuData"),u=o.menu,a=u.data("iw-menuData"),f=o.option;f.onOpen.call(this,{trigger:i,menu:u},r);var l=e(t).height(),c=e(t).width(),h=a.menuHeight,p=a.menuWidth,d=parseInt(f.verAdjust),v=parseInt(f.horAdjust),m=false;if(f.sizeStyle=="auto"){h=Math.min(h,l);p=Math.min(p,c)}if(f.displayAround=="cursor"){var g=r.pageX-e(t).scrollLeft(),y=r.pageY-e(t).scrollTop();var b=y+h,w=g+p;if(b>l){if(y-h<0){if(b-l<h-y){y=l-h;d=-1*d}else{y=0;d=0}}else{y=y-h;d=-1*d}}if(w>c){if(g-p<0){if(w-c<p-g){g=c-p;v=-1*v;m=true}else{g=0;v=0}}else{g=g-p;v=-1*v;m=true}}}else if(f.displayAround=="trigger"){var E=i.outerHeight(true),S=i.outerWidth(true),x=i.offset().left-e(t).scrollLeft(),T=i.offset().top-e(t).scrollTop(),g=x+S,y=T,N=S;var b=y+h,w=g+p;if(b>l){if(y-h<0){if(b-l<h-y){y=l-h;d=-1*d}else{y=0;d=0}}else{y=y-h+E;d=-1*d}}if(w>c){if(g-p<0){if(w-c<p-g){g=c-p;v=-1*v;m=true;N=-S}else{g=0;v=0;N=0}}else{g=g-p-S;v=-1*v;m=true;N=-S}}if(f.position=="top"){h=Math.min(a.menuHeight,T);y=T-h;d=parseInt(f.verAdjust);g=g-N}else if(f.position=="left"){p=Math.min(a.menuWidth,x);g=x-p;v=parseInt(f.horAdjust)}else if(f.position=="bottom"){h=Math.min(a.menuHeight,l-T-E);y=T+E;d=parseInt(f.verAdjust);g=g-N}else if(f.position=="right"){p=Math.min(a.menuWidth,c-x-S);g=x+S;v=parseInt(f.horAdjust)}}var C=u.outerWidth(true)-u.width(),k=u.outerHeight(true)-u.height();var L={display:"inline-block",top:y+d+"px",height:"",width:"","overflow-y":h!=a.menuHeight?"auto":"hidden","overflow-x":p!=a.menuWidth?"auto":"hidden"};if(f.sizeStyle=="auto"){L.height=h-k+"px";L.width=p-C+20+"px";g=g+20*(m?-1:0)}L.left=g+v+"px";u.css(L);if(!i.is("input,select,textarea")&&o.method=="menu"){e("#iw-tempTxt").focus()}if(i.closest(".iw-contextMenu").length==0){e(".iw-curMenu").removeClass("iw-curMenu");u.addClass("iw-curMenu")}e(n.documentElement).unbind("keyup",s.keyEvent);e("body").unbind("click",s.clickEvent);var A={trigger:i,menu:u,option:f,method:o.method};e("body").click(A,s.clickEvent);e(n.documentElement).keyup(A,s.keyEvent);e(t).bind("scroll resize",A,s.scrollEvent)},scrollEvent:function(e){s.closeContextMenu(e.data.option,e.data.trigger,e.data.menu,e)},clickEvent:function(t){var n=t.data.trigger.get(0);if(n!==t.target&&e(t.target).closest(".iw-contextMenu").length==0){s.closeContextMenu(t.data.option,t.data.trigger,t.data.menu,t)}},closeContextMenu:function(r,i,o,u){e(n.documentElement).unbind("keyup",s.keyEvent);e("body").unbind("click",s.clickEvent);e(t).unbind("scroll resize",s.scrollEvent);e(".iw-contextMenu").hide();e(n).focus();r.onClose.call(this,{trigger:i,menu:o},u)},keyEvent:function(t){var n=t.data.menu,r=t.data.option,i=t.keyCode;if(i==27){s.closeContextMenu(r,t.data.trigger,n,t)}if(t.data.method=="menu"){var o=e(".iw-curMenu"),u=o.children("li:not(.m-disable)"),a=u.filter(".iw-selectedMenu"),f=u.index(a),l=function(e){a.removeClass("iw-selectedMenu");e.addClass("iw-selectedMenu")},c=function(){l(u.filter(":first"))},h=function(){l(u.filter(":last"))},p=function(){l(u.filter(":eq("+(f+1)+")"))},d=function(){l(u.filter(":eq("+(f-1)+")"))},v=function(){var e=a.data("iw-menuData");if(e){a.triggerHandler("mouseenter.contextMenu");var t=e.menu;t.addClass("iw-curMenu");o.removeClass("iw-curMenu");o=t;u=o.children("li:not(.m-disable)");a=u.filter(".iw-selectedMenu");c()}},m=function(){var e=o.data("iw-menuData").trigger;var t=e.closest(".iw-contextMenu");if(t.length!=0){o.removeClass("iw-curMenu").css("display","none");t.addClass("iw-curMenu")}};switch(i){case 13:a.click();break;case 40:a.length==0?c():p();break;case 38:a.length==0?h():d();break;case 33:c();break;case 34:h();break;case 37:m();break;case 39:v();break}}},menuHover:function(t){t.children("li").bind("mouseenter",function(n){e(".iw-curMenu").removeClass("iw-curMenu");t.addClass("iw-curMenu");var r=t.find("li.iw-selectedMenu"),i=r.find(".iw-contextMenu");if(i.length!=0&&r[0]!=this){i.hide(100)}r.removeClass("iw-selectedMenu");e(this).addClass("iw-selectedMenu")})},createMenuList:function(t,n,r){var i=r.baseTrigger,o=Math.floor(Math.random()*1e4);if(typeof n=="object"&&!n.nodeType&&!n.jquery){var u=e('<ul class="iw-contextMenu iw-created" id="iw-contextMenu'+o+'"></ul>');for(var a=0;a<n.length;a++){var f=n[a].name,l=n[a].fun,c=n[a].subMenu,h=n[a].img||"",p=n[a].title||f,d=n[a].disable,v=e('<li title="'+p+'">'+f+"</li>");if(h!=null&&h!=""){v.prepend('<img src="'+h+'" align="absmiddle" style="width:20px; height:20px; margin-right:10px" />')}if(d=="true"){v.addClass("m-disable")}v.bind("click",l);u.append(v);if(c){v.append('<div class="iw-arrow-right" />');s.subMenu(v,c,i)}}if(i.index(t[0])==-1){t.append(u)}else{e("body").append(u)}s.onOff(e("#iw-contextMenu"+o));return"#iw-contextMenu"+o}else if(e(n).length!=0){var m=e(n);m.removeClass("iw-contextMenuCurrent").addClass("iw-contextMenu iw-contextMenu"+o).attr("menuId","iw-contextMenu"+o).css("display","none");m.find("ul").each(function(t,n){var r=e(this),o=r.parent("li");o.append('<div class="iw-arrow-right" />');r.addClass("iw-contextMenuCurrent");s.subMenu(o,".iw-contextMenuCurrent",i)});s.onOff(e(".iw-contextMenu"+o));return".iw-contextMenu"+o}},subMenu:function(e,t,n){e.contextMenu("menu",t,{triggerOn:"hover",displayAround:"trigger",position:"auto",baseTrigger:n})},onOff:function(t){t.find(".iw-overlay").remove();t.find(".m-disable").each(function(){var t=e(this);t.append('<div class="iw-overlay"/>');t.find(".iw-overlay").bind("click mouseenter",function(e){e.stopPropagation()})})},tempTextBox:function(){var t=e("#iw-tempTxt");if(t.length==0){e("body").append('<input type="text" id="iw-tempTxt" />');e("#iw-tempTxt").css({position:"fixed",bottom:"1px",left:"1px",width:"0px",border:"none"})}},optionOtimizer:function(e,t){if(!t){return}if(e=="menu"){if(!t.mouseClick){t.mouseClick="right"}}if(t.mouseClick=="right"&&t.triggerOn=="click"){t.triggerOn="contextmenu"}if(t.triggerOn!="click"&&t.triggerOn!="mousemove"){if(!t.displayAround){t.displayAround="trigger"}}if(["hover","mouseenter","mouseover","mouseleave","mouseout"].indexOf(t.triggerOn)!=-1){t.displayAround="trigger"}return t}}})(jQuery,window,document)